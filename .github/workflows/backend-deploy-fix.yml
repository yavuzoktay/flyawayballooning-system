name: Deploy Backend with Fixes

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/backend-deploy-fix.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "=== Starting Backend Deployment Fix ==="
          
          # Navigate to the project directory
          cd /home/ec2-user/flyawayballooning-system-backend
          
          # Pull latest changes
          git pull origin main
          
          # Create necessary directories
          echo "Creating necessary directories..."
          mkdir -p client/build
          mkdir -p server/uploads/activities
          
          # Create basic index.html if it doesn't exist
          if [ ! -f "client/build/index.html" ]; then
            echo "Creating basic index.html..."
            cat > client/build/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="utf-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>FlyAway Ballooning System</title>
          </head>
          <body>
              <div id="root">
                  <h1>FlyAway Ballooning System</h1>
                  <p>System is being deployed. Please wait...</p>
              </div>
          </body>
          </html>
          EOF
          fi
          
          # Set proper permissions
          echo "Setting proper permissions..."
          sudo chown -R nginx:nginx client/build
          sudo chmod -R 755 client/build
          sudo chown -R ec2-user:ec2-user server
          sudo chmod -R 755 server
          sudo chown -R ec2-user:ec2-user server/uploads
          sudo chmod -R 755 server/uploads
          
          # Stop all PM2 processes
          echo "Stopping all PM2 processes..."
          pm2 stop all
          pm2 delete all
          
          # Kill any existing Node.js processes
          echo "Killing any existing Node.js processes..."
          pkill -f "node.*index.js" || true
          pkill -f "node.*server" || true
          
          # Navigate to server directory
          cd server
          
          # Install dependencies
          echo "Installing server dependencies..."
          npm install
          
          # Start the server with PM2
          echo "Starting server with PM2..."
          PORT=3002 pm2 start index.js --name flyawayballooning-server
          
          # Save PM2 configuration
          echo "Saving PM2 configuration..."
          pm2 save
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 10
          
          # Check if server is running
          echo "Checking server status..."
          if curl -s http://localhost:3002/api/health > /dev/null; then
            echo "✓ Backend server is responding"
          else
            echo "✗ Backend server is not responding"
            echo "Checking PM2 logs..."
            pm2 logs flyawayballooning-server --lines 10
          fi
          
          # Update Nginx configuration
          echo "Updating Nginx configuration..."
          cd ..
          sudo cp nginx.conf /etc/nginx/nginx.conf
          
          # Test nginx configuration
          echo "Testing Nginx configuration..."
          sudo nginx -t
          
          # Restart nginx
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          
          # Fix SELinux if needed
          echo "Checking SELinux..."
          if command -v sestatus > /dev/null 2>&1; then
            if sestatus | grep -q "enabled"; then
              echo "SELinux is enabled, setting proper context..."
              sudo setsebool -P httpd_can_network_connect 1
              sudo setsebool -P httpd_can_network_relay 1
            fi
          fi
          
          # Check firewall
          echo "Checking firewall..."
          if command -v firewall-cmd > /dev/null 2>&1; then
            sudo firewall-cmd --permanent --add-port=80/tcp
            sudo firewall-cmd --permanent --add-port=3002/tcp
            sudo firewall-cmd --reload
          fi
          
          # Final status check
          echo "=== Final Status Check ==="
          
          # Check PM2 processes
          echo "PM2 processes:"
          pm2 list
          
          # Check if backend is responding
          echo "Backend health check:"
          curl -s http://localhost:3002/api/health || echo "Backend not responding"
          
          # Check what's listening on port 3002
          echo "Port 3002 status:"
          sudo netstat -tlnp | grep :3002 || echo "Nothing listening on port 3002"
          
          # Check nginx status
          echo "Nginx status:"
          sudo systemctl status nginx --no-pager
          
          # Check if index.html exists and is accessible
          echo "Checking if index.html exists:"
          ls -la /home/ec2-user/flyawayballooning-system-backend/client/build/index.html
          
          echo "=== Deployment completed ==="
          echo "Please check the website at http://flyawayballooning-system.com" 